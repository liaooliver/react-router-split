const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/firebase-CTRYxaob.js","assets/tslib.es6-_MLvj5KC.js","assets/chunk-KNED5TY2-Cl3wCyk9.js"])))=>i.map(i=>d[i]);
import{w as O}from"./tslib.es6-_MLvj5KC.js";import{o as U,r as N,l as t}from"./chunk-KNED5TY2-Cl3wCyk9.js";import{I as j}from"./Input-DF9ItDFb.js";import{f as V,R as $,a as I,S as F,b as q,c as G,d as W,e as z}from"./fetchCategories-B_jkLVhF.js";import{L as h}from"./Label-CIJG89ry.js";import{B as C}from"./Button-XTR6J30C.js";import{f as H,A as J,P as K}from"./fetchEventMembers-CLyGHwMF.js";import"./axios-DieNybu2.js";import"./firebase-CTRYxaob.js";import{i as Q}from"./auth-CDK0oIU7.js";import"./index-CyOlW-9v.js";import"./index-DUjh1uFd.js";import"./index-B0El3IGW.js";import"./createLucideIcon-BSR5BV8j.js";import"./arrow-left-DteMMKrF.js";import"./proxy-BMHVCQmy.js";const X="modulepreload",Y=function(c){return"/"+c},D={},P=function(f,d,b){let s=Promise.resolve();if(d&&d.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),r=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=Promise.allSettled(d.map(u=>{if(u=Y(u),u in D)return;D[u]=!0;const p=u.endsWith(".css"),w=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${w}`))return;const e=document.createElement("link");if(e.rel=p?"stylesheet":X,p||(e.as="script"),e.crossOrigin="",e.href=u,r&&e.setAttribute("nonce",r),document.head.appendChild(e),p)return new Promise((n,v)=>{e.addEventListener("load",n),e.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${u}`)))})}))}function m(o){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=o,window.dispatchEvent(r),!r.defaultPrevented)throw o}return s.then(o=>{for(const r of o||[])r.status==="rejected"&&m(r.reason);return f().catch(m)})};async function pe({params:c}){if(!await Q())throw new Response("未登入",{status:401});const d=c.id;if(!d)throw new Response("缺少 eventId",{status:400});const[b,s]=await Promise.all([H(d),V()]);return{members:b,categories:s,eventId:d}}function Z({loaderData:c}){const f=U(),[d]=N.useState(c.members.map(e=>e.name)),[b]=N.useState(c.categories),[s,m]=N.useState({description:"",total:"",payers:c.members.reduce((e,n)=>(e[n.name]=0,e),{}),splitType:"even",shares:c.members.reduce((e,n)=>(e[n.name]=0,e),{}),note:"",category:""}),[o,r]=N.useState(""),u=async()=>{var v,y;if(!s.description||!s.total){r("描述與總額為必填");return}const e=Object.values(s.payers).reduce((i,x)=>i+Number(x),0),n=s.splitType==="even"?e:Object.values(s.shares).reduce((i,x)=>i+Number(x),0);if(e!==Number(s.total)||n!==Number(s.total)){r("付款與分攤金額總和必須等於總額");return}try{const i=c.eventId;if(!i){r("找不到 eventId");return}let x=null;if(s.category){const a=c.categories.find(l=>l.name===s.category);a&&(x=a.id)}const g=a=>{const l=c.members.find(R=>R.name===a);return l?l.firebase_uid:null},_=Object.entries(s.payers).filter(([a,l])=>Number(l)>0).map(([a,l])=>({userId:g(a),name:a,amount:Number(l)})),S=Object.entries(s.shares).map(([a,l])=>({userId:g(a),name:a,amount:s.splitType==="even"?Number(s.total)/c.members.length:Number(l)}));console.log("shares",S);const{auth:T}=await P(async()=>{const{auth:a}=await import("./firebase-CTRYxaob.js").then(l=>l.f);return{auth:a}},__vite__mapDeps([0,1,2])),E=T.currentUser;if(!E){r("尚未登入");return}const k=await E.getIdToken(),{default:B}=await P(async()=>{const{default:a}=await import("./axios-DieNybu2.js").then(l=>l.c);return{default:a}},[]),A=new Date().toISOString(),L={eventId:i,description:s.description,total:Number(s.total),categoryId:x,payers:_,shares:S,note:s.note||null,createdAt:A};await B.post("/expenses",L,{headers:{Authorization:`Bearer ${k}`}}),f(`/events/${i}`)}catch(i){r(((y=(v=i==null?void 0:i.response)==null?void 0:v.data)==null?void 0:y.message)||i.message||"新增費用失敗，請稍後再試")}},p=()=>{f(-1)},w=e=>{m(n=>{const y=(Number(n.total)||0)/d.length,i=d.reduce((x,g)=>({...x,[g]:e==="even"?y:n.shares[g]}),{});return{...n,splitType:e,shares:i}})};return t.jsxs(J,{children:[t.jsx(K,{title:"新增費用"}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx(h,{className:"text-[#263238] text-sm font-medium",children:"描述"}),t.jsx(j,{value:s.description,onChange:e=>m({...s,description:e.target.value}),placeholder:"輸入費用描述",className:"mt-1 w-full h-10 border-[#D1D5DB] rounded-md bg-white text-black"})]}),t.jsxs("div",{children:[t.jsx(h,{className:"text-[#263238] text-sm font-medium",children:"總額 (TWD)"}),t.jsx(j,{type:"number",value:s.total,onChange:e=>m({...s,total:e.target.value}),placeholder:"輸入總額",className:"mt-1 w-full h-10 border-[#D1D5DB] rounded-md bg-white text-black"})]}),t.jsxs("div",{children:[t.jsx(h,{className:"text-[#263238] text-sm font-medium",children:"付款人"}),t.jsx("div",{className:"space-y-2 mt-1",children:d.map(e=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"w-20 text-[#263238]",children:e}),t.jsx(j,{type:"number",value:s.payers[e],onChange:n=>m({...s,payers:{...s.payers,[e]:n.target.value}}),className:"w-20 h-8 border-[#D1D5DB] rounded-md bg-white text-[#263238]"})]},e))})]}),t.jsxs("div",{children:[t.jsx(h,{className:"text-[#263238] text-sm font-medium",children:"分攤方式"}),t.jsxs($,{value:s.splitType,onValueChange:w,className:"mt-1 flex space-x-4",children:[t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(I,{value:"even",id:"even"}),t.jsx(h,{htmlFor:"even",className:"text-[#263238] text-sm",children:"平均分"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(I,{value:"manual",id:"manual"}),t.jsx(h,{htmlFor:"manual",className:"text-[#263238] text-sm",children:"手動調"})]})]})]}),s.splitType==="manual"&&t.jsxs("div",{children:[t.jsx(h,{className:"text-[#263238] text-sm font-medium",children:"分攤金額"}),t.jsx("div",{className:"space-y-2 mt-1",children:d.map(e=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("span",{className:"w-20 text-[#263238]",children:e}),t.jsx(j,{type:"number",value:s.shares[e],onChange:n=>m({...s,shares:{...s.shares,[e]:n.target.value}}),className:"w-20 h-8 border-[#D1D5DB] text-[#263238] rounded-md"})]},e))})]}),t.jsxs("div",{children:[t.jsx(h,{className:"text-[#263238] text-sm font-medium",children:"備註（選填）"}),t.jsx(j,{value:s.note,onChange:e=>m({...s,note:e.target.value}),placeholder:"備註（選填）",className:"mt-1 w-full h-10 border-[#D1D5DB] rounded-md bg-white text-black"})]}),t.jsxs("div",{children:[t.jsx(h,{className:"text-[#263238] text-sm font-medium",children:"類別（選填）"}),t.jsxs(F,{onValueChange:e=>m({...s,category:e}),value:s.category,children:[t.jsx(q,{className:"mt-1 w-full h-10 border-[#D1D5DB] rounded-md bg-white text-black",children:t.jsx(G,{placeholder:"選擇類別"})}),t.jsx(W,{children:b.map(e=>t.jsx(z,{value:e.name,children:e.name},e.id))})]})]}),o&&t.jsx("p",{className:"text-[#EF4444] text-xs",children:o})]}),t.jsxs("div",{className:"mt-4 flex justify-end space-x-2",children:[t.jsx(C,{variant:"outline",onClick:p,className:"w-20 h-10 border-[#D1D5DB] rounded-md bg-muted text-muted-foreground hover:bg-muted/90",children:"取消"}),t.jsx(C,{onClick:u,className:"w-20 h-10 rounded-md bg-primary text-primary-foreground hover:bg-primary/90",children:"儲存"})]})]})}const fe=O(Z);export{pe as clientLoader,fe as default};
