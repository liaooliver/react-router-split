import{w as U}from"./tslib.es6-_MLvj5KC.js";import{l as e,r as l,q as z}from"./chunk-KNED5TY2-Cl3wCyk9.js";import{a as V}from"./firebase-CTRYxaob.js";import{a as R,b as G}from"./axios-DieNybu2.js";import{D as W,b as J,d as K}from"./Dialog-CQYq49fn.js";import{f as Q,A,P as L}from"./fetchEventMembers-CLyGHwMF.js";import{C as X,d as Y}from"./Card-D9vF-guT.js";import{c as H}from"./createLucideIcon-BSR5BV8j.js";import{B as T}from"./Button-XTR6J30C.js";import{P as Z,A as ee,a as se,T as te,b as re,c as ae,f as ne}from"./AlertDialog-CiyVUyrQ.js";import{o as ie,r as O,s as C,e as le,c as B,u as oe,F as ce,a as v,b as p,d as P,f as N,g as b,h as de}from"./Form-R8bx5Sg7.js";import{I}from"./Input-DF9ItDFb.js";import{L as F}from"./Label-CIJG89ry.js";import{f as me,R as ue,a as q,S as he,b as xe,c as je,d as fe,e as ge}from"./fetchCategories-B_jkLVhF.js";import"./index-CyOlW-9v.js";import"./index-DUjh1uFd.js";import"./index-B0El3IGW.js";import"./arrow-left-DteMMKrF.js";import"./proxy-BMHVCQmy.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],ve=H("info",ye);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],_=H("user",pe);async function Ne(s){var r;const o=V.currentUser;if(!o)throw new Error("尚未登入");const n=await o.getIdToken();try{return(await R.get(`/expenses/${s}`,{headers:{Authorization:`Bearer ${n}`}})).data.data}catch(a){throw G.isAxiosError(a)&&a.response?new Error(((r=a.response.data)==null?void 0:r.message)||"取得費用詳情失敗"):new Error("取得費用詳情失敗")}}function be({expense:s}){return e.jsx(X,{children:e.jsxs(Y,{className:"space-y-1 pt-4",children:[e.jsx("div",{className:"text-base font-semibold text-gray-800",children:s.title}),e.jsxs("div",{className:"text-2xl font-bold text-gray-800",children:["$",s.amount.toFixed(2)]}),e.jsx("div",{className:"text-sm text-gray-500",children:s.date})]})})}function we({payers:s,shares:o}){return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1 text-sm font-medium text-gray-800",children:[e.jsx(_,{className:"w-4 h-4"}),e.jsx("span",{children:"付款人"})]}),e.jsx("div",{className:"pl-2 pt-2 space-y-2",children:s.map(n=>e.jsxs("div",{className:"text-gray-700",children:[n.name,"：$",n.amount.toFixed(2)]},n.userId))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1 text-sm font-medium text-gray-800",children:[e.jsx(_,{className:"w-4 h-4"}),e.jsx("span",{children:"分攤金額"})]}),e.jsx("div",{className:"pl-2 pt-2 space-y-2",children:o.map(n=>e.jsxs("div",{className:"text-gray-700",children:[n.name,"：$",n.amount.toFixed(2)]},n.userId))})]})]})}function Se({expense:s}){const o={equal:"平均分攤",exact:"自定義金額",percentage:"依比例分攤"};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-1 text-sm font-medium text-gray-800",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsx("span",{children:"分攤方式"})]}),e.jsx("div",{className:"pl-2 pt-2 text-gray-700",children:o[s.splitMethod]})]}),s.note&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-800",children:"備註"}),e.jsx("div",{className:"pl-2 pt-2 text-gray-700",children:s.note})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-800",children:"類別"}),e.jsx("div",{className:"pl-2 pt-2 text-gray-700",children:s.category})]})]})}function Ee({onEdit:s,onDelete:o}){const[n,r]=l.useState(!1),a=()=>{r(!0)},u=()=>{r(!1),o()};return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex justify-between pt-4",children:[e.jsxs(T,{onClick:s,className:"bg-[#FFC107] text-white hover:bg-yellow-500",children:[e.jsx(Z,{className:"mr-2 h-4 w-4"})," 編輯"]}),e.jsxs(ee,{open:n,onOpenChange:r,children:[e.jsx(se,{asChild:!0,children:e.jsxs(T,{onClick:a,className:"bg-red-500 text-white hover:bg-red-600",children:[e.jsx(te,{className:"mr-2 h-4 w-4"})," 刪除"]})}),e.jsxs(re,{children:[e.jsx(ae,{children:"確定要刪除這筆費用嗎？"}),e.jsxs(ne,{children:[e.jsx(T,{variant:"outline",onClick:()=>r(!1),children:"取消"}),e.jsx(T,{className:"bg-red-500 text-white",onClick:u,children:"確定刪除"})]})]})]})]})})}function De(s){const[o,n]=l.useState([]),[r,a]=l.useState(!1),[u,d]=l.useState(null);return l.useEffect(()=>{if(!s){n([]),d("eventId is required");return}a(!0),d(null),Q(s).then(n).catch(f=>{d(f.message||"取得成員失敗"),n([])}).finally(()=>a(!1))},[s]),{members:o,isLoading:r,error:u}}function Ce(){const[s,o]=l.useState([]),[n,r]=l.useState(!1),[a,u]=l.useState(null);return l.useEffect(()=>{r(!0),u(null),me().then(o).catch(d=>{u(d.message||"取得類別失敗"),o([])}).finally(()=>r(!1))},[]),{categories:s,isLoading:n,error:a}}const Te=ie({title:C().min(1,"請輸入費用名稱"),amount:B.number().min(.01,"金額必須大於 0").max(1e6,"金額太大"),date:C().min(1,"請選擇日期"),category:C().min(1,"請選擇類別"),splitType:le(["even","manual"],{required_error:"請選擇分攤方式"}),note:C().optional(),payers:O(C(),B.number()),shares:O(C(),B.number())});function Ie({expense:s,eventId:o,onSubmit:n,onCancel:r}){const{members:a,isLoading:u,error:d}=De(o?String(o):void 0),{categories:f,isLoading:w,error:M}=Ce(),[g,$]=l.useState(""),S=l.useMemo(()=>a.map(t=>t.id),[a]);function k(t=[],c=[]){const x=new Map(c.map(j=>[String(j.userId),j.amount]));return t.reduce((j,m)=>(j[String(m.id)]=x.get(String(m.firebase_uid))??0,j),{})}const i=oe({resolver:de(Te),defaultValues:{title:(s==null?void 0:s.title)||"",amount:(s==null?void 0:s.amount)||0,date:(s==null?void 0:s.date)||new Date().toISOString().split("T")[0],category:(s==null?void 0:s.category)||"餐費",splitType:(s==null?void 0:s.splitMethod)==="equal"?"even":"manual",note:(s==null?void 0:s.note)||"",payers:{},shares:{}}});l.useEffect(()=>{!a||a.length===0||i.reset({title:(s==null?void 0:s.title)||"",amount:(s==null?void 0:s.amount)||0,date:(s==null?void 0:s.date)||new Date().toISOString().split("T")[0],category:(s==null?void 0:s.category)||"餐費",splitType:(s==null?void 0:s.splitMethod)==="equal"?"even":"manual",note:(s==null?void 0:s.note)||"",payers:k(a,s==null?void 0:s.payers),shares:k(a,s==null?void 0:s.shares)})},[a,f,s]);const E=i.watch("amount"),D=i.watch("splitType");l.useEffect(()=>{if(D==="even"&&E&&S.length>0){const t=Number(E)/S.length,c=S.reduce((x,j)=>({...x,[j]:t}),{});i.setValue("shares",c)}},[E,D,S,i]);const h=t=>{const c=Object.values(t.payers).reduce((m,y)=>m+Number(y),0),x=Object.values(t.shares).reduce((m,y)=>m+Number(y),0);if(c!==Number(t.amount)||x!==Number(t.amount)){$("付款與分攤金額總和必須等於總額");return}const j={...t,payers:Object.entries(t.payers).map(([m,y])=>({userId:m,name:m,amount:Number(y)})),shares:Object.entries(t.shares).map(([m,y])=>({userId:m,name:m,amount:Number(y)}))};n(j)};return u||w?e.jsx("div",{children:"資料載入中..."}):d?e.jsxs("div",{className:"text-red-500",children:["成員載入失敗：",d]}):M?e.jsxs("div",{className:"text-red-500",children:["類別載入失敗：",M]}):e.jsx(ce,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(h),className:"space-y-6",children:[e.jsx(v,{control:i.control,name:"title",render:({field:t})=>e.jsxs(p,{children:[e.jsx(P,{children:"描述"}),e.jsx(N,{children:e.jsx(I,{placeholder:"輸入費用描述",...t})}),e.jsx(b,{})]})}),e.jsx(v,{control:i.control,name:"amount",render:({field:t})=>e.jsxs(p,{children:[e.jsx(P,{children:"總額 (TWD)"}),e.jsx(N,{children:e.jsx(I,{type:"number",step:"0.01",placeholder:"輸入總額",...t,value:t.value??0})}),e.jsx(b,{})]})}),e.jsxs("div",{children:[e.jsx(F,{className:"text-[#263238] text-sm font-medium",children:"付款人"}),e.jsx("div",{className:"space-y-2 mt-1",children:a.map(t=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"w-20 text-[#263238]",children:t.name}),e.jsx(v,{control:i.control,name:`payers.${t.id}`,render:({field:c})=>e.jsxs(p,{children:[e.jsx(N,{children:e.jsx(I,{type:"number",className:"w-32 h-8 border-[#D1D5DB] rounded-md bg-white",...c,value:c.value??0})}),e.jsx(b,{})]})})]},t.id))})]}),e.jsxs("div",{children:[e.jsx(F,{className:"text-[#263238] text-sm font-medium",children:"分攤方式"}),e.jsx(v,{control:i.control,name:"splitType",render:({field:t})=>e.jsxs(p,{children:[e.jsx(N,{children:e.jsxs(ue,{onValueChange:t.onChange,value:t.value,className:"mt-1 flex space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(q,{value:"even",id:"even"}),e.jsx(F,{htmlFor:"even",className:"text-[#263238] text-sm",children:"平均分"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(q,{value:"manual",id:"manual"}),e.jsx(F,{htmlFor:"manual",className:"text-[#263238] text-sm",children:"手動調"})]})]})}),e.jsx(b,{})]})})]}),D==="manual"&&e.jsxs("div",{children:[e.jsx(F,{className:"text-[#263238] text-sm font-medium",children:"分攤金額"}),e.jsx("div",{className:"space-y-2 mt-1",children:a.map(t=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"w-20 text-[#263238]",children:t.name}),e.jsx(v,{control:i.control,name:`shares.${t.id}`,render:({field:c})=>e.jsxs(p,{children:[e.jsx(N,{children:e.jsx(I,{type:"number",className:"w-32 h-8 border-[#D1D5DB] rounded-md",...c,value:c.value??0})}),e.jsx(b,{})]})})]},t.id))})]}),e.jsx(v,{control:i.control,name:"category",render:({field:t})=>e.jsxs(p,{children:[e.jsx(P,{children:"類別"}),e.jsx(N,{children:e.jsxs(he,{onValueChange:t.onChange,value:t.value,children:[e.jsx(xe,{children:e.jsx(je,{placeholder:"請選擇類別"})}),e.jsx(fe,{children:f.map(c=>e.jsx(ge,{value:c.name,children:c.name},c.id))})]})}),e.jsx(b,{})]})}),e.jsx(v,{control:i.control,name:"note",render:({field:t})=>e.jsxs(p,{children:[e.jsx(P,{children:"備註（選填）"}),e.jsx(N,{children:e.jsx(I,{placeholder:"備註（選填）",...t})}),e.jsx(b,{})]})}),g&&e.jsx("p",{className:"text-[#EF4444] text-xs",children:g}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx(T,{type:"button",variant:"outline",onClick:r,className:"border-[#D1D5DB] rounded-md bg-muted text-muted-foreground hover:bg-muted/90",children:"取消"}),e.jsx(T,{type:"submit",children:"儲存"})]})]})})}const Ke=U(function(){const n=z().id,[r,a]=l.useState(null),[u,d]=l.useState(!0),[f,w]=l.useState(null),[M,g]=l.useState(!1);l.useEffect(()=>{n&&(d(!0),w(null),Ne(n).then(a).catch(i=>w(i.message||"發生未知錯誤")).finally(()=>d(!1)))},[n]);const $=()=>{g(!0)},S=()=>{console.log("刪除成功")},k=async i=>{var E,D;if(r){d(!0),w(null);try{const h=V.currentUser;if(!h)throw new Error("尚未登入");const t=await h.getIdToken(),c={...i};await R.put(`/expenses/${r.id}`,c,{headers:{Authorization:`Bearer ${t}`}}),a(x=>x&&{...x,...i}),g(!1)}catch(h){w(((D=(E=h==null?void 0:h.response)==null?void 0:E.data)==null?void 0:D.message)||h.message||"更新費用失敗，請稍後再試")}finally{d(!1)}}};return u?e.jsxs(A,{children:[e.jsx(L,{title:"費用詳情"}),e.jsx("div",{children:"載入中..."})]}):f?e.jsxs(A,{children:[e.jsx(L,{title:"費用詳情"}),e.jsx("div",{className:"text-red-500",children:f})]}):r?e.jsxs(A,{children:[e.jsx(L,{title:"費用詳情"}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(be,{expense:r}),e.jsx(we,{payers:r.payers,shares:r.shares}),e.jsx(Se,{expense:r}),e.jsx(Ee,{onEdit:$,onDelete:S})]}),e.jsx(W,{open:M,onOpenChange:g,children:e.jsxs(J,{className:"sm:max-w-[500px] bg-white text-black",children:[e.jsx(K,{children:"編輯費用"}),e.jsx(Ie,{expense:r,eventId:r.eventId,onSubmit:k,onCancel:()=>g(!1)})]})})]}):e.jsxs(A,{children:[e.jsx(L,{title:"費用詳情"}),e.jsx("div",{children:"查無資料"})]})});export{Ke as default};
