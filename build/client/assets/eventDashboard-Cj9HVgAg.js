import{w as L}from"./tslib.es6-_MLvj5KC.js";import{l as e,r as u,p as M}from"./chunk-KNED5TY2-Cl3wCyk9.js";import{a as C,c as O}from"./firebase-CTRYxaob.js";import{a as y,b as U}from"./axios-DieNybu2.js";import{B as p}from"./Button-XTR6J30C.js";import{C as H,d as K}from"./Card-D9vF-guT.js";import{A as W,a as G,b as X}from"./Avatar-DzPfjhJg.js";import{D as q,a as Q,b as Z,c as J,d as V,e as Y,X as ee}from"./Dialog-CQYq49fn.js";import{I as R}from"./Input-DF9ItDFb.js";import{a as S,A as te,P as se}from"./fetchEventMembers-CLyGHwMF.js";import{P as ae,T as re,A as ne,a as ie,b as le,c as oe,d as ce,e as de,f as me,g as he,h as xe}from"./AlertDialog-CiyVUyrQ.js";import{D as ue,P as ge}from"./DebtOverview-Jl1onUf-.js";import{b as fe,c as pe}from"./fetchProtectedData-CIjgaTnl.js";import{c as je}from"./createLucideIcon-BSR5BV8j.js";import{i as be}from"./auth-CDK0oIU7.js";import"./index-DUjh1uFd.js";import"./index-B0El3IGW.js";import"./index-CyOlW-9v.js";import"./arrow-left-DteMMKrF.js";import"./proxy-BMHVCQmy.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],k=je("triangle-alert",ve);async function T(r){const t=C.currentUser;if(!t)throw new Error("尚未登入");const n=await t.getIdToken();try{return(await y.get(`/events/${r}`,{headers:{Authorization:`Bearer ${n}`}})).data}catch(a){throw U.isAxiosError(a)&&a.response?a.response.data:new Error("取得事件詳情失敗")}}const we=["#0066CC","#FFC107","#2196F3","#FF9800","#4caf50","#e91e63"],Ne=({data:r,totalAmount:t})=>{let n=0;const a=r.map((g,h)=>{const j=g.amount/t*100/100*360,o=n+j,i=(n-90)*Math.PI/180,x=(o-90)*Math.PI/180,b=40+30*Math.cos(i),D=40+30*Math.sin(i),v=40+30*Math.cos(x),l=40+30*Math.sin(x),E=j>180?1:0,c=`M 40 40 L ${b} ${D} A 30 30 0 ${E} 1 ${v} ${l} Z`;return n=o,e.jsx("path",{d:c,fill:we[h],stroke:"#fff",strokeWidth:"1",className:"transition-all duration-300 hover:opacity-80"},h)});return e.jsxs("div",{className:"relative",children:[e.jsxs("svg",{viewBox:"0 0 80 80",width:"120",height:"120",className:"mx-auto",children:[a,e.jsx("circle",{cx:"40",cy:"40",r:"15",fill:"#fff"}),e.jsxs("text",{x:"40",y:"44",textAnchor:"middle",fontSize:"8",fontWeight:"bold",fill:"#263238",children:["$",t]})]}),e.jsx("div",{className:"absolute -top-2 -right-2 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-xs",children:"$"})})]})},De=({text:r})=>e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh]",children:[e.jsx("div",{className:"animate-spin rounded-full h-14 w-14 border-t-4 border-b-4 border-[#00C4CC] mb-4"}),e.jsx("div",{className:"text-lg text-[#263238] font-medium",children:r||"載入中..."})]});function Ee(r,t){return t.some(n=>n.name.toLowerCase()===r.toLowerCase())}const Ce="請輸入 Email",ye="此成員名稱已存在",Ae="檢查 Email 錯誤：",Ie="加入現有用戶失敗：",Me="註冊或同步失敗：";function Re(r){return Math.random().toString(36).slice(-10)}async function ke({userId:r,eventId:t,clearInput:n,refreshEventDetail:a,setErrorMessage:g,setShowError:h}){try{await S({event_id:t,user_id:r}),n(),a()}catch(m){g(Ie+((m==null?void 0:m.message)||"")),h(!0)}}async function Se({email:r,name:t,eventId:n,clearInput:a,refreshEventDetail:g,setErrorMessage:h,setShowError:m}){const j=Re();try{const i=(await O(C,r,j)).user,x=await i.getIdToken();await fe({email:i.email,displayName:t.trim()||i.email,uid:i.uid,idToken:x}),await S({event_id:n,user_id:i.uid}),a(),g()}catch(o){h(Me+((o==null?void 0:o.message)||"")),m(!0)}}async function et({params:r}){if(!await be())throw new Response("未登入",{status:401});const n=r.id;try{return{event:(await T(n)).data}}catch(a){throw new Response(a.message||"資料載入失敗",{status:500})}}const Te=({loaderData:r})=>{const[t,n]=u.useState(r.event),[a,g]=u.useState(!1),[h,m]=u.useState(!1),[j,o]=u.useState(null),[i,x]=u.useState(""),[b,D]=u.useState(""),[v,l]=u.useState(""),[E,c]=u.useState(!1);function A(){D(""),x(""),m(!1),c(!1)}const I=async()=>{if(!b.trim()){l("請輸入 Email"),l(Ce),c(!0);return}if(i.trim()&&Ee(i.trim(),t.members)){l(ye),c(!0);return}try{const s=await pe(b);if(s.exist){await ke({userId:s.exists.firebase_uid,eventId:t.eventId,clearInput:A,refreshEventDetail:N,setErrorMessage:l,setShowError:c});return}await Se({email:b,name:i,eventId:t.eventId,clearInput:A,refreshEventDetail:N,setErrorMessage:l,setShowError:c})}catch(s){l(Ae+((s==null?void 0:s.message)||"")),c(!0)}},F=s=>!t.expenses.some(d=>d.paidBy===s),$=s=>{if(!F(s)){l("此成員已參與費用記錄，無法移除"),c(!0);return}o(null),c(!1)},B=async s=>{var d,w;try{l("");const f=C.currentUser;if(!f)throw new Error("尚未登入");const z=await f.getIdToken();await y.delete(`/expenses/${s}`,{headers:{Authorization:`Bearer ${z}`}}),await N()}catch(f){l(((w=(d=f==null?void 0:f.response)==null?void 0:d.data)==null?void 0:w.message)||f.message||"刪除費用失敗")}},P=async()=>{const s=(t==null?void 0:t.balances.reduce((d,w)=>d+w.amount,0))||0;if(Math.abs(s)>.01){l("餘額總和不為 0，請檢查費用");return}try{const d=C.currentUser;if(!d)throw new Error("尚未登入");const w=await d.getIdToken();await y.post(`/settlement/events/${t.eventId}/settle`,{},{headers:{Authorization:`Bearer ${w}`}}),N()}catch{l("結算失敗，請稍後再試。")}},N=async()=>{try{const s=await T(t.eventId);n(s.data)}catch{l("重新載入失敗，請稍後再試。")}},_=()=>e.jsxs("div",{className:"w-full flex p-3 bg-white border border-[#D1D5DB] rounded-lg overflow-scroll",children:[e.jsxs(q,{open:h,onOpenChange:m,children:[e.jsx(Q,{asChild:!0,children:e.jsxs("div",{className:"flex flex-col items-center mr-4",children:[e.jsx("div",{className:"w-10 h-10 bg-[#0066CC] rounded-full flex items-center justify-center cursor-pointer hover:bg-[#0052A3] transition-colors",children:e.jsx(ge,{className:"h-5 w-5 text-white"})}),e.jsx("span",{className:"text-xs mt-1 text-black",children:"新增"})]})}),e.jsxs(Z,{className:"sm:max-w-[425px] bg-white text-black",children:[e.jsx(J,{children:e.jsx(V,{children:"發送邀請"})}),e.jsxs("div",{className:"py-4",children:[E&&e.jsxs("div",{className:"flex items-center space-x-2 mb-2 p-2 bg-red-50 rounded text-red-600 text-sm",children:[e.jsx(k,{className:"h-4 w-4"}),e.jsx("span",{children:v})]}),e.jsx(R,{placeholder:"輸入成員名稱 (選填)",value:i,onChange:s=>x(s.target.value),className:"mb-2"}),e.jsx(R,{placeholder:"輸入 Email",value:b,onChange:s=>D(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),I())}})]}),e.jsxs(Y,{children:[e.jsx(p,{variant:"outline",className:"w-20 h-10 border-[#D1D5DB] rounded-md bg-muted text-muted-foreground hover:bg-muted/90",onClick:()=>{m(!1),c(!1),x("")},children:"取消"}),e.jsx(p,{onClick:I,disabled:!i.trim(),className:"w-20 h-10 rounded-md bg-primary text-primary-foreground hover:bg-primary/90",children:"添加"})]})]})]}),t.members.length>0&&e.jsx("div",{className:"h-10 w-px bg-[#D1D5DB] mx-2"}),t.members.map(s=>e.jsxs("div",{className:"flex flex-col items-center mx-2 relative group",children:[e.jsxs(W,{className:"w-10 h-10 border-2 border-transparent group-hover:border-[#0066CC] transition-colors",children:[e.jsx(G,{src:s.avatar,alt:s.name}),e.jsx(X,{className:"bg-[#F3F4F6]",children:s.name.charAt(0).toUpperCase()})]}),e.jsx("span",{className:"text-xs mt-1 text-black",children:s.name}),e.jsxs(ne,{open:j===s.id,onOpenChange:d=>!d&&o(null),children:[e.jsx(ie,{asChild:!0,children:e.jsx("button",{className:"absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600",onClick:()=>o(s.id),children:e.jsx(ee,{className:"h-3 w-3 text-white"})})}),e.jsxs(le,{children:[e.jsxs(oe,{children:[e.jsx(ce,{children:"移除成員"}),e.jsx(de,{children:E?e.jsxs("div",{className:"flex items-center space-x-2 text-red-600",children:[e.jsx(k,{className:"h-4 w-4"}),e.jsx("span",{children:v})]}):e.jsxs(e.Fragment,{children:["確定要移除成員 ",s.name," 嗎？",e.jsx("br",{}),"移除後無法恢復，且已參與費用記錄的成員無法移除。"]})})]}),e.jsxs(me,{children:[e.jsx(he,{onClick:()=>{c(!1),o(null)},children:"取消"}),e.jsx(xe,{onClick:()=>$(s.id),className:"bg-red-500 hover:bg-red-600",children:"確認移除"})]})]})]})]},s.id))]});return t?e.jsxs(te,{children:[e.jsx(se,{title:t.title,path:"/"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h2",{className:"text-base font-medium text-[#263238] mb-2",children:"成員"}),t&&_()]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h2",{className:"text-base font-medium text-[#263238] mb-2",children:"類別分佈與統計"}),e.jsx("div",{className:"p-3 bg-white border border-[#D1D5DB] rounded-lg",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(Ne,{data:t.categoryDistribution,totalAmount:t.totalAmount}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsxs("div",{className:"text-xs text-[#263238]",children:["參與人數：",t.members.length," 人"]}),e.jsxs("div",{className:"text-xs text-[#263238]",children:["人均花費：$",(t.totalAmount/t.members.length).toFixed(2)]})]})]})})]}),(t.status==="settled"||t.status==="finalized")&&e.jsxs("div",{className:"text-center mb-4",children:[t.status==="settled"&&e.jsx("p",{className:"text-base font-medium text-green-500",children:"已結算"}),t.status==="finalized"&&e.jsx("p",{className:"text-base font-medium text-yellow-500",children:"已結束"}),e.jsx(p,{variant:"outline",className:"mt-2 w-48 border-[#D1D5DB] rounded-md",onClick:()=>g(!a),children:a?"隱藏費用列表":"展開費用列表"})]}),t.status!=="settled"&&t.status!=="finalized"||a?e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h2",{className:"text-base font-medium text-[#263238]",children:"費用列表"}),t.status!=="settled"&&t.status!=="finalized"&&e.jsx(M,{to:{pathname:`/addExpense/${t.eventId}`},children:e.jsx(p,{className:"bg-[#00C4CC] text-white cursor-pointer rounded px-3 h-9 hover:bg-[#00B0B6]",children:"新增費用"})})]}),e.jsx("div",{className:"space-y-2",children:t.expenses.length===0?e.jsx("div",{className:"text-sm text-center text-gray-400",children:"目前無費用記錄"}):t.expenses.map(s=>e.jsx(H,{className:"w-full h-14 border border-[#D1D5DB] rounded-lg",children:e.jsxs(K,{className:"flex items-center justify-between h-full px-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:s.category==="food"?"🍽️":s.category==="drinks"?"🥤":"📦"}),e.jsxs("p",{className:"text-sm text-[#263238]",children:[s.title," - $",s.amount]})]}),t.status!=="settled"&&t.status!=="finalized"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{to:`/expenseDetails/${s.id}`,children:e.jsx(p,{variant:"ghost",size:"icon",children:e.jsx(ae,{className:"w-4 h-4 text-[#00C4CC]"})})}),e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>B(s.id),children:e.jsx(re,{className:"w-4 h-4 text-red-500"})})]})]})},s.id))})]}):null,(t.status==="settled"||t.status==="finalized")&&e.jsxs("div",{className:"mb-4",children:[t.debts.length>0&&e.jsx(ue,{debts:t.debts,onPaidSuccess:N}),t.debts.length===0&&e.jsx("div",{className:"text-sm text-center text-gray-400",children:"目前無債務關係"})]}),t.status!=="settled"&&t.status!=="finalized"&&e.jsxs("div",{className:"text-center mt-4",children:[v&&e.jsx("p",{className:"text-xs text-red-500 mb-2",children:v}),e.jsx(p,{className:"w-full bg-[#FF5733] cursor-pointer text-white rounded h-12 hover:bg-[#E84C2E]",onClick:P,children:"結算"})]})]}):e.jsx(De,{text:"活動資料載入中..."})},tt=L(Te);export{et as clientLoader,tt as default};
